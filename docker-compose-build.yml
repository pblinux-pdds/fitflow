services:
  fitflow-gw:
    build:
      context: ./fitflow-gw
      tags:
        - fitflow-gw:latest
    ports:
      - "80:${GW_PORT}"
    depends_on:
      - signup
      - subscription
      - signup-database
      - subscription-database
    environment:
      - GW_PORT=${GW_PORT}
      - SIGNUP_HOST=${SIGNUP_HOST}
      - SIGNUP_PORT=${SIGNUP_PORT}
      - SUBSCRIPTION_HOST=${SUBSCRIPTION_HOST}
      - SUBSCRIPTION_PORT=${SUBSCRIPTION_PORT}
      - JWT_SECRET=${JWT_SECRET}

  signup:
    build: 
      context: ./fitflow-signup
      tags:
        - fitflow-signup:latest
    ports:
      - "${SIGNUP_PORT}:${SIGNUP_PORT}"
    depends_on:
      - signup-database
    environment:
      - SIGNUP_HOST=${SIGNUP_HOST}
      - SIGNUP_PORT=${SIGNUP_PORT}
      - DB_HOST=${SIGNUP_DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_SIGNUP_NAME}
      - JWT_SECRET=${JWT_SECRET}

  signup-database:
    image: postgres
    ports:
      - "5433:${DB_PORT}"
    volumes:
      - "signup-database:/var/lib/postgresql/data"
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      - POSTGRES_DB=${DB_SIGNUP_NAME}

  subscription:
    build: 
      context: ./fitflow-subscription
      tags:
        - fitflow-subscription:latest
    ports:
      - "${SUBSCRIPTION_PORT}:${SUBSCRIPTION_PORT}"
    depends_on:
      - signup
      - subscription-database
    environment:
      - SIGNUP_HOST=${SIGNUP_HOST}
      - SIGNUP_PORT=${SIGNUP_PORT}
      - SUBSCRIPTION_HOST=${SUBSCRIPTION_HOST}
      - SUBSCRIPTION_PORT=${SUBSCRIPTION_PORT}
      - DB_HOST=${SUBSCRIPTION_DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_SUBSCRIPTION_NAME}
  
  subscription-database:
    image: postgres
    ports:
      - "5434:${DB_PORT}"
    volumes:
      - "subscription-database:/var/lib/postgresql/data"
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      - POSTGRES_DB=${DB_SUBSCRIPTION_NAME}

volumes:
  signup-database:
  subscription-database: